
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://eitansuez.github.io/ambient-migration/migrate/">
      
      
        <link rel="prev" href="../migration-plan/">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.16">
    
    
      
        <title>Migrate to Ambient - Migrating from Sidecars to Ambient Mesh</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#migrate-to-ambient" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Migrating from Sidecars to Ambient Mesh" class="md-header__button md-logo" aria-label="Migrating from Sidecars to Ambient Mesh" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Migrating from Sidecars to Ambient Mesh
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Migrate to Ambient
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/eitansuez/ambient-migration" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Migrating from Sidecars to Ambient Mesh" class="md-nav__button md-logo" aria-label="Migrating from Sidecars to Ambient Mesh" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Migrating from Sidecars to Ambient Mesh
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/eitansuez/ambient-migration" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Introduction
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../pre-analysis/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Initial Considerations
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../setup/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Setup
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../migration-plan/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Migration plan
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Migrate to Ambient
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Migrate to Ambient
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#download-the-migration-tool" class="md-nav__link">
    <span class="md-ellipsis">
      Download the migration tool
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#try-the-migration-tool" class="md-nav__link">
    <span class="md-ellipsis">
      Try the migration tool
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#upgrade-istio" class="md-nav__link">
    <span class="md-ellipsis">
      Upgrade Istio
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Upgrade Istio">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#soloios-istio-distribution" class="md-nav__link">
    <span class="md-ellipsis">
      Solo.io's Istio distribution
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#upgrade-the-cni-to-use-the-ambient-profile" class="md-nav__link">
    <span class="md-ellipsis">
      Upgrade the CNI to use the ambient profile
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#upgrade-istiod-with-the-ambient-profile" class="md-nav__link">
    <span class="md-ellipsis">
      Upgrade istiod with the ambient profile
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-ztunnel" class="md-nav__link">
    <span class="md-ellipsis">
      Install ztunnel
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#validate-the-upgrade" class="md-nav__link">
    <span class="md-ellipsis">
      Validate the upgrade
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#migration-assistant-whats-next" class="md-nav__link">
    <span class="md-ellipsis">
      Migration assistant, what's next?
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#assistant-whats-next" class="md-nav__link">
    <span class="md-ellipsis">
      Assistant, what's next?
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploy-the-waypoint" class="md-nav__link">
    <span class="md-ellipsis">
      Deploy the waypoint
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Deploy the waypoint">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#turn-on-access-logging" class="md-nav__link">
    <span class="md-ellipsis">
      Turn on access logging
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#back-to-the-assistant" class="md-nav__link">
    <span class="md-ellipsis">
      Back to the Assistant
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#apply-retrofitted-authorization-policies" class="md-nav__link">
    <span class="md-ellipsis">
      Apply retrofitted authorization policies
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bind-the-waypoint-to-the-services" class="md-nav__link">
    <span class="md-ellipsis">
      Bind the waypoint to the services
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#switch-to-ambient-mode" class="md-nav__link">
    <span class="md-ellipsis">
      Switch to ambient mode
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Switch to ambient mode">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#migrate-the-backend" class="md-nav__link">
    <span class="md-ellipsis">
      Migrate the backend
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#migrate-the-frontend" class="md-nav__link">
    <span class="md-ellipsis">
      Migrate the frontend
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#validate" class="md-nav__link">
    <span class="md-ellipsis">
      Validate
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#assistant-one-more-time" class="md-nav__link">
    <span class="md-ellipsis">
      Assistant, one more time
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#test-everything" class="md-nav__link">
    <span class="md-ellipsis">
      Test everything
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Test everything">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#test-ingress" class="md-nav__link">
    <span class="md-ellipsis">
      Test Ingress
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test-authorization-policies" class="md-nav__link">
    <span class="md-ellipsis">
      Test authorization policies
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test-traffic-policy" class="md-nav__link">
    <span class="md-ellipsis">
      Test traffic policy
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    <span class="md-ellipsis">
      Summary
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#download-the-migration-tool" class="md-nav__link">
    <span class="md-ellipsis">
      Download the migration tool
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#try-the-migration-tool" class="md-nav__link">
    <span class="md-ellipsis">
      Try the migration tool
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#upgrade-istio" class="md-nav__link">
    <span class="md-ellipsis">
      Upgrade Istio
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Upgrade Istio">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#soloios-istio-distribution" class="md-nav__link">
    <span class="md-ellipsis">
      Solo.io's Istio distribution
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#upgrade-the-cni-to-use-the-ambient-profile" class="md-nav__link">
    <span class="md-ellipsis">
      Upgrade the CNI to use the ambient profile
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#upgrade-istiod-with-the-ambient-profile" class="md-nav__link">
    <span class="md-ellipsis">
      Upgrade istiod with the ambient profile
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-ztunnel" class="md-nav__link">
    <span class="md-ellipsis">
      Install ztunnel
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#validate-the-upgrade" class="md-nav__link">
    <span class="md-ellipsis">
      Validate the upgrade
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#migration-assistant-whats-next" class="md-nav__link">
    <span class="md-ellipsis">
      Migration assistant, what's next?
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#assistant-whats-next" class="md-nav__link">
    <span class="md-ellipsis">
      Assistant, what's next?
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploy-the-waypoint" class="md-nav__link">
    <span class="md-ellipsis">
      Deploy the waypoint
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Deploy the waypoint">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#turn-on-access-logging" class="md-nav__link">
    <span class="md-ellipsis">
      Turn on access logging
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#back-to-the-assistant" class="md-nav__link">
    <span class="md-ellipsis">
      Back to the Assistant
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#apply-retrofitted-authorization-policies" class="md-nav__link">
    <span class="md-ellipsis">
      Apply retrofitted authorization policies
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bind-the-waypoint-to-the-services" class="md-nav__link">
    <span class="md-ellipsis">
      Bind the waypoint to the services
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#switch-to-ambient-mode" class="md-nav__link">
    <span class="md-ellipsis">
      Switch to ambient mode
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Switch to ambient mode">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#migrate-the-backend" class="md-nav__link">
    <span class="md-ellipsis">
      Migrate the backend
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#migrate-the-frontend" class="md-nav__link">
    <span class="md-ellipsis">
      Migrate the frontend
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#validate" class="md-nav__link">
    <span class="md-ellipsis">
      Validate
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#assistant-one-more-time" class="md-nav__link">
    <span class="md-ellipsis">
      Assistant, one more time
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#test-everything" class="md-nav__link">
    <span class="md-ellipsis">
      Test everything
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Test everything">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#test-ingress" class="md-nav__link">
    <span class="md-ellipsis">
      Test Ingress
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test-authorization-policies" class="md-nav__link">
    <span class="md-ellipsis">
      Test authorization policies
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test-traffic-policy" class="md-nav__link">
    <span class="md-ellipsis">
      Test traffic policy
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    <span class="md-ellipsis">
      Summary
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="migrate-to-ambient">Migrate to Ambient</h1>
<h2 id="download-the-migration-tool">Download the migration tool</h2>
<p>Per the <a href="https://ambientmesh.io/docs/setup/sidecar-migration/#download-the-migration-helper">documented instructions</a>, we can obtain the migration helper with:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>curl<span class="w"> </span>-sL<span class="w"> </span>https://storage.googleapis.com/gloo-cli/install.sh<span class="w"> </span><span class="p">|</span><span class="w"> </span>sh
</span></code></pre></div>
<p>The output tells us that we can add the <code>gloo</code> binary to our path with:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="nb">export</span><span class="w"> </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$HOME</span>/.gloo/bin:<span class="nv">$PATH</span>
</span></code></pre></div>
<p>The command comes with different options flag, but the general form of the command we will run is:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>gloo<span class="w"> </span>ambient<span class="w"> </span>migrate
</span></code></pre></div>
<h2 id="try-the-migration-tool">Try the migration tool</h2>
<p>Try the migration helper now:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>gloo<span class="w"> </span>ambient<span class="w"> </span>migrate
</span></code></pre></div>
<p>Study the output:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="go">• Starting phase pre-reqs...</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="go">✅ Phase pre-reqs succeeded!</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="go">  ✅ Cluster CNI compatibility: passed</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="go">  ✅ Istio version compatibility: passed</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="go">  ✅ Multicluster usage compatibility: passed</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="go">  ✅ Virtual Machine usage compatibility: passed</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="go">  ✅ SPIRE usage compatibility: passed</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="go">• Starting phase cluster-setup...</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="go">❌ Phase cluster-setup failed!</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="go">  ❌ Ambient mode enabled: failed. 1 error occurred:</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a><span class="go">        * istiod istio-system/istiod must have &#39;PILOT_ENABLE_AMBIENT=true&#39;. Upgrade Istio with &#39;--set profile=ambient&#39;.</span>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a><span class="go">  ❌ DaemonSets deployed: failed. 1 error occurred:</span>
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a><span class="go">        * ztunnel not found</span>
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a>
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a>
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a><span class="go">  ❌ Sidecars support ambient mode: failed. 7 errors occurred:</span>
</span><span id="__span-4-20"><a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a><span class="go">        * Sidecar backend/details-v1-7d775cb4f6-s657b is missing &#39;ENABLE_HBONE&#39;. Upgrade Istio with &#39;--set profile=ambient&#39; and restart the pod.</span>
</span><span id="__span-4-21"><a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a><span class="go">        * Sidecar backend/ratings-v1-5b896f8544-h7qw6 is missing &#39;ENABLE_HBONE&#39;. Upgrade Istio with &#39;--set profile=ambient&#39; and restart the pod.</span>
</span><span id="__span-4-22"><a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a><span class="go">        * Sidecar backend/reviews-v1-746f96c9d4-55wxl is missing &#39;ENABLE_HBONE&#39;. Upgrade Istio with &#39;--set profile=ambient&#39; and restart the pod.</span>
</span><span id="__span-4-23"><a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a><span class="go">        * Sidecar backend/reviews-v2-97bdf5876-r5kg9 is missing &#39;ENABLE_HBONE&#39;. Upgrade Istio with &#39;--set profile=ambient&#39; and restart the pod.</span>
</span><span id="__span-4-24"><a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a><span class="go">        * Sidecar backend/reviews-v3-77d9db6844-fbwf6 is missing &#39;ENABLE_HBONE&#39;. Upgrade Istio with &#39;--set profile=ambient&#39; and restart the pod.</span>
</span><span id="__span-4-25"><a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a><span class="go">        * Sidecar frontend/curl-5b549b49b8-xthm5 is missing &#39;ENABLE_HBONE&#39;. Upgrade Istio with &#39;--set profile=ambient&#39; and restart the pod.</span>
</span><span id="__span-4-26"><a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a><span class="go">        * Sidecar frontend/productpage-v1-85b8f8d74b-tsw5q is missing &#39;ENABLE_HBONE&#39;. Upgrade Istio with &#39;--set profile=ambient&#39; and restart the pod.</span>
</span><span id="__span-4-27"><a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a>
</span><span id="__span-4-28"><a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a>
</span><span id="__span-4-29"><a id="__codelineno-4-29" name="__codelineno-4-29" href="#__codelineno-4-29"></a><span class="go">  ✅ Required CRDs installed: passed</span>
</span></code></pre></div>
<p>This output should begin to provide a validation for our plan:</p>
<ul>
<li>
<p>Among other things, it validates Istio version and Cluster CNI compatibility.  If we had used too old a version of Istio, the tool would have raised a concern, and our first priority would be to upgrade Istio to a newer version.</p>
</li>
<li>
<p>We also get a validation that all necessary CRDs are installed.  I assume the reference is to the Gateway API CRDs.</p>
</li>
</ul>
<p>The tool also helps us look forward and tells us what's not yet in place:</p>
<ul>
<li>We haven't yet upgraded to ambient mode.  We're told to use the <code>--set profile=ambient</code> flag.</li>
<li>ztunnel is not yet installed</li>
</ul>
<p>Let's get to work.</p>
<h2 id="upgrade-istio">Upgrade Istio</h2>
<h3 id="soloios-istio-distribution">Solo.io's Istio distribution</h3>
<p>Solo.io's distribution of Istio provides sidecar to ambient interoperability that ensures that mesh policies continue to function in environments with mixed sidecar and sidecarless workloads, specifically in situations where services have been upgraded to ambient while sidecar clients remain.</p>
<p>Solo.io's distribution ensures that requests to ambient services from these sidecar clients are routed through the waypoints that enforce authorization and other mesh policies.</p>
<p>See <a href="https://docs.solo.io/gloo-mesh/latest/ambient/about/images/overview/">Solo distributions of Istio</a> for more information.</p>
<h3 id="upgrade-the-cni-to-use-the-ambient-profile">Upgrade the CNI to use the ambient profile</h3>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">OSS Istio</label><label for="__tabbed_1_2">Solo.io Distribution</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-shell highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>helm<span class="w"> </span>upgrade<span class="w"> </span>istio-cni<span class="w"> </span>istio/cni<span class="w"> </span>-n<span class="w"> </span>istio-system<span class="w"> </span><span class="se">\</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="w">  </span>--set<span class="w"> </span>global.platform<span class="o">=</span>k3d<span class="w"> </span>--set<span class="w"> </span><span class="nv">profile</span><span class="o">=</span>ambient<span class="w"> </span>--wait
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-shell highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>helm<span class="w"> </span>upgrade<span class="w"> </span>istio-cni<span class="w"> </span>oci://<span class="nv">$HELM_REPO</span>/cni<span class="w"> </span>-n<span class="w"> </span>istio-system<span class="w"> </span>--version<span class="w"> </span><span class="nv">$TAG</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="w">  </span>--set<span class="w"> </span>global.hub<span class="o">=</span><span class="nv">$HUB</span><span class="w"> </span>--set<span class="w"> </span>global.tag<span class="o">=</span><span class="nv">$TAG</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="w">  </span>--set<span class="w"> </span>global.platform<span class="o">=</span>k3d<span class="w"> </span>--set<span class="w"> </span><span class="nv">profile</span><span class="o">=</span>ambient<span class="w"> </span>--wait
</span></code></pre></div>
</div>
</div>
</div>
<h3 id="upgrade-istiod-with-the-ambient-profile">Upgrade <code>istiod</code> with the ambient profile</h3>
<div class="tabbed-set tabbed-alternate" data-tabs="2:2"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><input id="__tabbed_2_2" name="__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="__tabbed_2_1">OSS Istio</label><label for="__tabbed_2_2">Solo.io Distribution</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-shell highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>helm<span class="w"> </span>upgrade<span class="w"> </span>istiod<span class="w"> </span>istio/istiod<span class="w"> </span>-n<span class="w"> </span>istio-system<span class="w"> </span>--set<span class="w"> </span><span class="nv">profile</span><span class="o">=</span>ambient<span class="w"> </span>--wait
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-shell highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>helm<span class="w"> </span>upgrade<span class="w"> </span>istiod<span class="w"> </span>oci://<span class="nv">$HELM_REPO</span>/istiod<span class="w"> </span>-n<span class="w"> </span>istio-system<span class="w"> </span>--version<span class="w"> </span><span class="nv">$TAG</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="w">  </span>--set<span class="w"> </span>global.hub<span class="o">=</span><span class="nv">$HUB</span><span class="w"> </span>--set<span class="w"> </span>global.tag<span class="o">=</span><span class="nv">$TAG</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="w">  </span>--set<span class="w"> </span><span class="nv">profile</span><span class="o">=</span>ambient<span class="w"> </span><span class="se">\</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="w">  </span>--set<span class="w"> </span>license.value<span class="o">=</span><span class="nv">$SOLO_LICENSE_KEY</span><span class="w"> </span>--wait
</span></code></pre></div>
</div>
</div>
</div>
<h3 id="install-ztunnel">Install ztunnel</h3>
<div class="tabbed-set tabbed-alternate" data-tabs="3:2"><input checked="checked" id="__tabbed_3_1" name="__tabbed_3" type="radio" /><input id="__tabbed_3_2" name="__tabbed_3" type="radio" /><div class="tabbed-labels"><label for="__tabbed_3_1">OSS Istio</label><label for="__tabbed_3_2">Solo.io Distribution</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-shell highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>helm<span class="w"> </span>install<span class="w"> </span>ztunnel<span class="w"> </span>istio/ztunnel<span class="w"> </span>-n<span class="w"> </span>istio-system<span class="w"> </span>--set<span class="w"> </span>global.platform<span class="o">=</span>k3d<span class="w"> </span>--wait
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-shell highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>helm<span class="w"> </span>install<span class="w"> </span>ztunnel<span class="w"> </span>oci://<span class="nv">$HELM_REPO</span>/ztunnel<span class="w"> </span>-n<span class="w"> </span>istio-system<span class="w"> </span>--version<span class="w"> </span><span class="nv">$TAG</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="w">  </span>--set<span class="w"> </span><span class="nv">hub</span><span class="o">=</span><span class="nv">$HUB</span><span class="w"> </span>--set<span class="w"> </span><span class="nv">tag</span><span class="o">=</span><span class="nv">$TAG</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="w">  </span>--set<span class="w"> </span>global.platform<span class="o">=</span>k3d<span class="w"> </span>--set<span class="w"> </span><span class="nv">profile</span><span class="o">=</span>ambient<span class="w"> </span>--wait
</span></code></pre></div>
</div>
</div>
</div>
<h3 id="validate-the-upgrade">Validate the upgrade</h3>
<p>List all Helm installations:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>helm<span class="w"> </span>ls<span class="w"> </span>-A
</span></code></pre></div>
<p>The output should corroborate that all components are installed, along with their versions.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="go">NAME            NAMESPACE       REVISION        UPDATED                                 STATUS          CHART           APP VERSION</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="go">istio-base      istio-system    1               2025-06-04 15:01:02.654247 +0700 +07    deployed        base-1.26.1     1.26.1</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="go">istio-cni       istio-system    2               2025-06-05 11:34:51.192029 +0700 +07    deployed        cni-1.26.1      1.26.1</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="go">istiod          istio-system    2               2025-06-05 11:34:59.327015 +0700 +07    deployed        istiod-1.26.1   1.26.1</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="go">ztunnel         istio-system    1               2025-06-05 11:35:38.388524 +0700 +07    deployed        ztunnel-1.26.1  1.26.1</span>
</span></code></pre></div>
<p>Next, list all pods in the <code>istio-system</code> namespace:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>kubectl<span class="w"> </span>get<span class="w"> </span>pod<span class="w"> </span>-n<span class="w"> </span>istio-system
</span></code></pre></div>
<p>The output should indicate that the CNI agent, <code>ztunnel</code>, and <code>istiod</code> are all running:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="go">NAME                      READY   STATUS    RESTARTS   AGE</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="go">istio-cni-node-wsld7      1/1     Running   0          2m25s</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="go">istiod-86849665c6-87lvg   1/1     Running   0          2m17s</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="go">ztunnel-zkzn8             1/1     Running   0          99s</span>
</span></code></pre></div>
<h2 id="migration-assistant-whats-next">Migration assistant, what's next?</h2>
<p>This is a good time to re-run the migration tool to see where we stand:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>gloo<span class="w"> </span>ambient<span class="w"> </span>migrate
</span></code></pre></div>
<p>The output has changed:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="go">• Starting phase pre-reqs...</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="go">✅ Phase pre-reqs succeeded!</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="go">  ✅ Cluster CNI compatibility: passed</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="go">  ✅ Istio version compatibility: passed</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="go">  ✅ Multicluster usage compatibility: passed</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="go">  ✅ Virtual Machine usage compatibility: passed</span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="go">  ✅ SPIRE usage compatibility: passed</span>
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a>
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="go">• Starting phase cluster-setup...</span>
</span><span id="__span-16-10"><a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a><span class="go">❌ Phase cluster-setup failed!</span>
</span><span id="__span-16-11"><a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a><span class="go">  ✅ Ambient mode enabled: passed</span>
</span><span id="__span-16-12"><a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a><span class="go">  ✅ DaemonSets deployed: passed</span>
</span><span id="__span-16-13"><a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a><span class="go">  ❌ Sidecars support ambient mode: failed. 7 errors occurred:</span>
</span><span id="__span-16-14"><a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a><span class="go">        * Sidecar backend/details-v1-7d775cb4f6-s657b is missing &#39;ENABLE_HBONE&#39;. Upgrade Istio with &#39;--set profile=ambient&#39; and restart the pod.</span>
</span><span id="__span-16-15"><a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a><span class="go">        * Sidecar backend/ratings-v1-5b896f8544-h7qw6 is missing &#39;ENABLE_HBONE&#39;. Upgrade Istio with &#39;--set profile=ambient&#39; and restart the pod.</span>
</span><span id="__span-16-16"><a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a><span class="go">        * Sidecar backend/reviews-v1-746f96c9d4-55wxl is missing &#39;ENABLE_HBONE&#39;. Upgrade Istio with &#39;--set profile=ambient&#39; and restart the pod.</span>
</span><span id="__span-16-17"><a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a><span class="go">        * Sidecar backend/reviews-v2-97bdf5876-r5kg9 is missing &#39;ENABLE_HBONE&#39;. Upgrade Istio with &#39;--set profile=ambient&#39; and restart the pod.</span>
</span><span id="__span-16-18"><a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a><span class="go">        * Sidecar backend/reviews-v3-77d9db6844-fbwf6 is missing &#39;ENABLE_HBONE&#39;. Upgrade Istio with &#39;--set profile=ambient&#39; and restart the pod.</span>
</span><span id="__span-16-19"><a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a><span class="go">        * Sidecar frontend/curl-5b549b49b8-xthm5 is missing &#39;ENABLE_HBONE&#39;. Upgrade Istio with &#39;--set profile=ambient&#39; and restart the pod.</span>
</span><span id="__span-16-20"><a id="__codelineno-16-20" name="__codelineno-16-20" href="#__codelineno-16-20"></a><span class="go">        * Sidecar frontend/productpage-v1-85b8f8d74b-tsw5q is missing &#39;ENABLE_HBONE&#39;. Upgrade Istio with &#39;--set profile=ambient&#39; and restart the pod.</span>
</span><span id="__span-16-21"><a id="__codelineno-16-21" name="__codelineno-16-21" href="#__codelineno-16-21"></a>
</span><span id="__span-16-22"><a id="__codelineno-16-22" name="__codelineno-16-22" href="#__codelineno-16-22"></a>
</span><span id="__span-16-23"><a id="__codelineno-16-23" name="__codelineno-16-23" href="#__codelineno-16-23"></a><span class="go">  ✅ Required CRDs installed: passed</span>
</span></code></pre></div>
<p>In ambient mode, sidecar workloads must have the HBONE protocol enabled in order to communicate with sidecarless workloads.</p>
<p>In order to effect that change, the assistant instructs us to restart the pods that represent our workloads.</p>
<p>This is a good example of a step that we hadn't considered in our plan.</p>
<p>In scenarios where we expect to run a mix of workloads, some sidecar-based and others sidecarless, this step would be important.</p>
<p>Go ahead and heed the recommendation by restarting the workloads:</p>
<p><div class="language-shell highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>kubectl<span class="w"> </span>rollout<span class="w"> </span>restart<span class="w"> </span>deploy<span class="w"> </span>-n<span class="w"> </span>backend
</span></code></pre></div>
And:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a>kubectl<span class="w"> </span>rollout<span class="w"> </span>restart<span class="w"> </span>deploy<span class="w"> </span>-n<span class="w"> </span>frontend
</span></code></pre></div>
<p>Note that the above are still running sidecars.</p>
<h2 id="assistant-whats-next">Assistant, what's next?</h2>
<p>You know the drill by now:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a>gloo<span class="w"> </span>ambient<span class="w"> </span>migrate
</span></code></pre></div>
<p>Here is the salient output:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="go">• Starting phase deploy-waypoints...</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="go">⚠ Phase deploy-waypoints has recommendations!</span>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="go">  🔮 Namespace &quot;backend&quot; might require a waypoint for the following services:</span>
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="go">     * Service &quot;backend/details&quot; selected workload apps/v1/Deployment/backend/details-v1 requires a waypoint:</span>
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="go">         AuthorizationPolicy backend/details-authz requires a waypoint due to HTTP attributes (methods)</span>
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a>
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a><span class="go">     * Service &quot;backend/details-v1&quot; selected workload apps/v1/Deployment/backend/details-v1 requires a waypoint:</span>
</span><span id="__span-20-8"><a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a><span class="go">         AuthorizationPolicy backend/details-authz requires a waypoint due to HTTP attributes (methods)</span>
</span><span id="__span-20-9"><a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a>
</span><span id="__span-20-10"><a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a><span class="go">     * Service &quot;backend/ratings&quot; selected workload apps/v1/Deployment/backend/ratings-v1 requires a waypoint:</span>
</span><span id="__span-20-11"><a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a><span class="go">         AuthorizationPolicy backend/ratings-authz requires a waypoint due to HTTP attributes (methods)</span>
</span><span id="__span-20-12"><a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a>
</span><span id="__span-20-13"><a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a><span class="go">     * Service &quot;backend/ratings-v1&quot; selected workload apps/v1/Deployment/backend/ratings-v1 requires a waypoint:</span>
</span><span id="__span-20-14"><a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a><span class="go">         AuthorizationPolicy backend/ratings-authz requires a waypoint due to HTTP attributes (methods)</span>
</span><span id="__span-20-15"><a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a>
</span><span id="__span-20-16"><a id="__codelineno-20-16" name="__codelineno-20-16" href="#__codelineno-20-16"></a>
</span><span id="__span-20-17"><a id="__codelineno-20-17" name="__codelineno-20-17" href="#__codelineno-20-17"></a><span class="go">  ℹ Generated waypoints written to /tmp/istio-migrate/recommended-waypoints.yaml</span>
</span></code></pre></div>
<p>The assistant has validated our analysis that:</p>
<ul>
<li>The authorization policies on backend services require a waypoint.</li>
<li>The authorization policy on frontend services do not necessitate a waypoint.</li>
</ul>
<p>It's interesting that it hasn't determined that <code>reviews</code> needs a waypoint too, on account of its traffic policy.</p>
<p>On the other hand, it's awfully nice to see a generated waypoint provided by the assistant:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a>cat<span class="w"> </span>/tmp/istio-migrate/recommended-waypoints.yaml
</span></code></pre></div>
<p>Here is the generated waypoint, it's a Gateway resource:</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gateway.networking.k8s.io/v1</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Gateway</span>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">waypoint</span>
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">backend</span>
</span><span id="__span-22-6"><a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-22-7"><a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a><span class="w">  </span><span class="nt">gatewayClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">istio-waypoint</span>
</span><span id="__span-22-8"><a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a><span class="w">  </span><span class="nt">listeners</span><span class="p">:</span>
</span><span id="__span-22-9"><a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mesh</span>
</span><span id="__span-22-10"><a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">15008</span>
</span><span id="__span-22-11"><a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a><span class="w">    </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HBONE</span>
</span></code></pre></div>
<h2 id="deploy-the-waypoint">Deploy the waypoint</h2>
<p>The waypoint can be deployed by applying the migration assistant's recommended manifest:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>/tmp/istio-migrate/recommended-waypoints.yaml
</span></code></pre></div>
<p>Alternatively, use the <code>istioctl waypoint apply</code> command, like so:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a>istioctl<span class="w"> </span>waypoint<span class="w"> </span>apply<span class="w"> </span>--namespace<span class="w"> </span>backend
</span></code></pre></div>
<p>Note however that just applying the waypoint does not also bind it to specific workloads.</p>
<p>Verify that the waypoint is present in the <code>backend</code> namespace:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a>istioctl<span class="w"> </span>waypoint<span class="w"> </span>list<span class="w"> </span>-n<span class="w"> </span>backend
</span></code></pre></div>
<p>Here is the output:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="go">NAME         REVISION     PROGRAMMED</span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="go">waypoint     default      True</span>
</span></code></pre></div>
<h3 id="turn-on-access-logging">Turn on access logging</h3>
<p>The Telemetry API allows us to enable access logging:</p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">telemetry.yaml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-27-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-27-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-27-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-27-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-27-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-27-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-27-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-27-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-27-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-27-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1"></a><span class="nn">---</span>
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">telemetry.istio.io/v1</span>
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Telemetry</span>
</span><span id="__span-27-4"><a id="__codelineno-27-4" name="__codelineno-27-4"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-27-5"><a id="__codelineno-27-5" name="__codelineno-27-5"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">enable-cluster-wide-waypoint-logging</span>
</span><span id="__span-27-6"><a id="__codelineno-27-6" name="__codelineno-27-6"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">istio-system</span>
</span><span id="__span-27-7"><a id="__codelineno-27-7" name="__codelineno-27-7"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-27-8"><a id="__codelineno-27-8" name="__codelineno-27-8"></a><span class="w">  </span><span class="nt">accessLogging</span><span class="p">:</span>
</span><span id="__span-27-9"><a id="__codelineno-27-9" name="__codelineno-27-9"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">providers</span><span class="p">:</span>
</span><span id="__span-27-10"><a id="__codelineno-27-10" name="__codelineno-27-10"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">envoy</span>
</span></code></pre></div></td></tr></table></div>
<p>Apply the resource:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>artifacts/telemetry.yaml
</span></code></pre></div>
<p>This will give us the ability to view traffic transiting the waypoint through its logs.</p>
<p>Here is the command to tail the waypoint logs:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a>kubectl<span class="w"> </span>logs<span class="w"> </span>--follow<span class="w"> </span>-n<span class="w"> </span>backend<span class="w"> </span>deploy/waypoint
</span></code></pre></div>
<h2 id="back-to-the-assistant">Back to the Assistant</h2>
<p>Re-run the assistant:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a>gloo<span class="w"> </span>ambient<span class="w"> </span>migrate
</span></code></pre></div>
<p>Study the output:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="go">...</span>
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a><span class="go">• Starting phase migrate-policies...</span>
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a><span class="go">⚠ Phase migrate-policies has recommendations!</span>
</span><span id="__span-31-4"><a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a><span class="go">  🔮 Apply security.istio.io/v1/AuthorizationPolicy/backend/details-from-waypoint: v1/Service/backend/details must allow traffic from its waypoint.</span>
</span><span id="__span-31-5"><a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a><span class="go">  🔮 Apply security.istio.io/v1/AuthorizationPolicy/backend/details-details-authz: Existing configuration is copied from policy backend/details-authz to be enforced at the waypoint.</span>
</span><span id="__span-31-6"><a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a><span class="go">  🔮 Apply security.istio.io/v1/AuthorizationPolicy/backend/details-v1-from-waypoint: v1/Service/backend/details-v1 must allow traffic from its waypoint.</span>
</span><span id="__span-31-7"><a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a><span class="go">  🔮 Apply security.istio.io/v1/AuthorizationPolicy/backend/details-v1-details-authz: Existing configuration is copied from policy backend/details-authz to be enforced at the waypoint.</span>
</span><span id="__span-31-8"><a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a><span class="go">  🔮 Apply security.istio.io/v1/AuthorizationPolicy/backend/ratings-from-waypoint: v1/Service/backend/ratings must allow traffic from its waypoint.</span>
</span><span id="__span-31-9"><a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a><span class="go">  🔮 Apply security.istio.io/v1/AuthorizationPolicy/backend/ratings-ratings-authz: Existing configuration is copied from policy backend/ratings-authz to be enforced at the waypoint.</span>
</span><span id="__span-31-10"><a id="__codelineno-31-10" name="__codelineno-31-10" href="#__codelineno-31-10"></a><span class="go">  🔮 Apply security.istio.io/v1/AuthorizationPolicy/backend/ratings-v1-from-waypoint: v1/Service/backend/ratings-v1 must allow traffic from its waypoint.</span>
</span><span id="__span-31-11"><a id="__codelineno-31-11" name="__codelineno-31-11" href="#__codelineno-31-11"></a><span class="go">  🔮 Apply security.istio.io/v1/AuthorizationPolicy/backend/ratings-v1-ratings-authz: Existing configuration is copied from policy backend/ratings-authz to be enforced at the waypoint.</span>
</span><span id="__span-31-12"><a id="__codelineno-31-12" name="__codelineno-31-12" href="#__codelineno-31-12"></a><span class="go">  ℹ Recommended policies written to /tmp/istio-migrate/recommended-policies.yaml</span>
</span></code></pre></div>
<p>We get a mention that the waypoint will be used for specific backend services.
We make a mental note of that.</p>
<p>The salient section tells us what we expected:  that our authorization policies must be retrofitted to use a <code>targetRefs</code> field.</p>
<p>Rather than do the work ourselves, the tool has provided the resources in the file <code>recommended-policies.yaml</code>.</p>
<h2 id="apply-retrofitted-authorization-policies">Apply retrofitted authorization policies</h2>
<p>It's worth mentioned that we are not yet deleting any existing authorization policies.
Rather, we add the equivalent policies that will function in the context of the waypoints.</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>/tmp/istio-migrate/recommended-policies.yaml
</span></code></pre></div>
<p>A close look at the recommended policies shows that the tool is doing its due diligence to permit requests that target either the <code>ratings</code> and <code>ratings-v1</code> services, and similarly for the <code>details</code> and <code>details-v1</code> services.</p>
<p>A closer look at the recommended policies reveals two things:</p>
<ol>
<li>The recommended policies include L4 authorization policies explicitly allowing the waypoint to communicate with the target service (<code>details</code>, <code>ratings</code>).  This is technically not required for the system to function, but it ensures that only the waypoint can communicate with the service (i.e. that no client bypasses the waypoint).</li>
<li>The tool is doing its due diligence to permit requests that target either the <code>ratings</code> and <code>ratings-v1</code> services, and similarly for the <code>details</code> and <code>details-v1</code> services.</li>
</ol>
<h2 id="bind-the-waypoint-to-the-services">Bind the waypoint to the services</h2>
<p>Another run of the assistant points this out:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="go">• Starting phase use-waypoints...</span>
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a><span class="go">⚠ Phase use-waypoints has recommendations!</span>
</span><span id="__span-33-3"><a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a><span class="go">  ⚠ Waypoint backend/waypoint is not used by any services.</span>
</span><span id="__span-33-4"><a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a><span class="go">  🔮 Service v1/Service/backend/details requires a waypoint, but is not configured to use one. To configure it: kubectl label service -n backend details istio.io/use-waypoint=waypoint</span>
</span><span id="__span-33-5"><a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a><span class="go">  🔮 Service v1/Service/backend/details-v1 requires a waypoint, but is not configured to use one. To configure it: kubectl label service -n backend details-v1 istio.io/use-waypoint=waypoint</span>
</span><span id="__span-33-6"><a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a><span class="go">  🔮 Service v1/Service/backend/ratings requires a waypoint, but is not configured to use one. To configure it: kubectl label service -n backend ratings istio.io/use-waypoint=waypoint</span>
</span><span id="__span-33-7"><a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a><span class="go">  🔮 Service v1/Service/backend/ratings-v1 requires a waypoint, but is not configured to use one. To configure it: kubectl label service -n backend ratings-v1 istio.io/use-waypoint=waypoint</span>
</span></code></pre></div>
<p>It suggests binding the waypoint to our services by labeling each service with the <code>istio.io/use-waypoint</code> conventional label.</p>
<p>Here we know that in addition to <code>ratings</code> and <code>details</code>, we must also label <code>reviews</code> services to use the waypoint, in order to support the traffic policy that is in place for <code>reviews</code>.</p>
<p>It seems silly to label every single service in the <code>backend</code> namespace.
Since in this case all workloads in <code>backend</code> should be enrolled to use the waypoint, let's just label the namespace:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a>kubectl<span class="w"> </span>label<span class="w"> </span>namespace<span class="w"> </span>backend<span class="w"> </span>istio.io/use-waypoint<span class="o">=</span>waypoint
</span></code></pre></div>
<p>Re-run the assistant to validate that all services have the associated waypoint.</p>
<h2 id="switch-to-ambient-mode">Switch to ambient mode</h2>
<p>It's time to finally switch to ambient mode.</p>
<h3 id="migrate-the-backend">Migrate the backend</h3>
<p>Remove the sidecar injection label:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a>kubectl<span class="w"> </span>label<span class="w"> </span>namespace<span class="w"> </span>backend<span class="w"> </span>istio-injection-
</span></code></pre></div>
<p>Replace it with the <code>dataplane-mode=ambient</code> label (ensures that ztunnel intercepts traffic in and out of our workloads):</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a>kubectl<span class="w"> </span>label<span class="w"> </span>namespace<span class="w"> </span>backend<span class="w"> </span>istio.io/dataplane-mode<span class="o">=</span>ambient
</span></code></pre></div>
<p>Restart the backend deployments to remove the sidecars:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a>kubectl<span class="w"> </span>rollout<span class="w"> </span>restart<span class="w"> </span>deploy<span class="w"> </span>-n<span class="w"> </span>backend<span class="w"> </span>details-v1
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a>kubectl<span class="w"> </span>rollout<span class="w"> </span>restart<span class="w"> </span>deploy<span class="w"> </span>-n<span class="w"> </span>backend<span class="w"> </span>ratings-v1
</span><span id="__span-37-3"><a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a>kubectl<span class="w"> </span>rollout<span class="w"> </span>restart<span class="w"> </span>deploy<span class="w"> </span>-n<span class="w"> </span>backend<span class="w"> </span>reviews-v1
</span><span id="__span-37-4"><a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a>kubectl<span class="w"> </span>rollout<span class="w"> </span>restart<span class="w"> </span>deploy<span class="w"> </span>-n<span class="w"> </span>backend<span class="w"> </span>reviews-v2
</span><span id="__span-37-5"><a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a>kubectl<span class="w"> </span>rollout<span class="w"> </span>restart<span class="w"> </span>deploy<span class="w"> </span>-n<span class="w"> </span>backend<span class="w"> </span>reviews-v3
</span></code></pre></div>
<h3 id="migrate-the-frontend">Migrate the frontend</h3>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a>kubectl<span class="w"> </span>label<span class="w"> </span>namespace<span class="w"> </span>frontend<span class="w"> </span>istio-injection-
</span><span id="__span-38-2"><a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a>kubectl<span class="w"> </span>label<span class="w"> </span>namespace<span class="w"> </span>frontend<span class="w"> </span>istio.io/dataplane-mode<span class="o">=</span>ambient
</span><span id="__span-38-3"><a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a>kubectl<span class="w"> </span>rollout<span class="w"> </span>restart<span class="w"> </span>deploy<span class="w"> </span>-n<span class="w"> </span>frontend
</span></code></pre></div>
<h3 id="validate">Validate</h3>
<p>Verify that all pods in <code>frontend</code> and <code>backend</code> have a single container:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a>kubectl<span class="w"> </span>get<span class="w"> </span>pod<span class="w"> </span>-n<span class="w"> </span>frontend
</span><span id="__span-39-2"><a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a>kubectl<span class="w"> </span>get<span class="w"> </span>pod<span class="w"> </span>-n<span class="w"> </span>backend
</span></code></pre></div>
<p>The <code>istioctl</code> CLI also provides <code>ztunnel-config</code> commands to verify the traffic traveling through ztunnel and waypoint proxies, and assigned workload identity certificates:</p>
<ol>
<li>
<p>Verify that workloads use the HBONE protocol:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a>istioctl<span class="w"> </span>ztunnel-config<span class="w"> </span>workload
</span></code></pre></div>
<div class="language-console highlight"><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="go">NAMESPACE     POD NAME                                ADDRESS      NODE                    WAYPOINT PROTOCOL</span>
</span><span id="__span-41-2"><a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a><span class="go">backend       details-v1-76cb4f574f-nqhtw             10.42.0.40   k3d-my-cluster-server-0 None     HBONE</span>
</span><span id="__span-41-3"><a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a><span class="go">backend       ratings-v1-5bf4c88c5c-qbnq5             10.42.0.39   k3d-my-cluster-server-0 None     HBONE</span>
</span><span id="__span-41-4"><a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a><span class="go">backend       reviews-v1-6899c69cc5-zqmbb             10.42.0.43   k3d-my-cluster-server-0 None     HBONE</span>
</span><span id="__span-41-5"><a id="__codelineno-41-5" name="__codelineno-41-5" href="#__codelineno-41-5"></a><span class="go">backend       reviews-v2-74dd9df8fc-2z62b             10.42.0.42   k3d-my-cluster-server-0 None     HBONE</span>
</span><span id="__span-41-6"><a id="__codelineno-41-6" name="__codelineno-41-6" href="#__codelineno-41-6"></a><span class="go">backend       reviews-v3-5598c69cc5-8jzld             10.42.0.41   k3d-my-cluster-server-0 None     HBONE</span>
</span><span id="__span-41-7"><a id="__codelineno-41-7" name="__codelineno-41-7" href="#__codelineno-41-7"></a><span class="go">backend       waypoint-56f487d8f8-q9qpk               10.42.0.44   k3d-my-cluster-server-0 None     TCP</span>
</span><span id="__span-41-8"><a id="__codelineno-41-8" name="__codelineno-41-8" href="#__codelineno-41-8"></a><span class="go">frontend      curl-678c94dfbb-bqwph                   10.42.0.37   k3d-my-cluster-server-0 None     HBONE</span>
</span><span id="__span-41-9"><a id="__codelineno-41-9" name="__codelineno-41-9" href="#__codelineno-41-9"></a><span class="go">frontend      productpage-v1-5bf9bf9f89-w6k5m         10.42.0.38   k3d-my-cluster-server-0 None     HBONE</span>
</span></code></pre></div>
</li>
<li>
<p>Verify the services associated with the waypoint in the <code>backend</code> namespace:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a>istioctl<span class="w"> </span>ztunnel-config<span class="w"> </span>service
</span></code></pre></div>
<div class="language-console highlight"><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="go">NAMESPACE     SERVICE NAME   SERVICE VIP   WAYPOINT ENDPOINTS</span>
</span><span id="__span-43-2"><a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a><span class="go">backend       details        10.43.87.252  waypoint 1/1</span>
</span><span id="__span-43-3"><a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a><span class="go">backend       details-v1     10.43.121.191 waypoint 1/1</span>
</span><span id="__span-43-4"><a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a><span class="go">backend       ratings        10.43.18.135  waypoint 1/1</span>
</span><span id="__span-43-5"><a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a><span class="go">backend       ratings-v1     10.43.154.253 waypoint 1/1</span>
</span><span id="__span-43-6"><a id="__codelineno-43-6" name="__codelineno-43-6" href="#__codelineno-43-6"></a><span class="go">backend       reviews        10.43.176.233 waypoint 3/3</span>
</span><span id="__span-43-7"><a id="__codelineno-43-7" name="__codelineno-43-7" href="#__codelineno-43-7"></a><span class="go">backend       reviews-v1     10.43.135.223 waypoint 1/1</span>
</span><span id="__span-43-8"><a id="__codelineno-43-8" name="__codelineno-43-8" href="#__codelineno-43-8"></a><span class="go">backend       reviews-v2     10.43.73.229  waypoint 1/1</span>
</span><span id="__span-43-9"><a id="__codelineno-43-9" name="__codelineno-43-9" href="#__codelineno-43-9"></a><span class="go">backend       reviews-v3     10.43.114.154 waypoint 1/1</span>
</span><span id="__span-43-10"><a id="__codelineno-43-10" name="__codelineno-43-10" href="#__codelineno-43-10"></a><span class="go">backend       waypoint       10.43.41.47   None     1/1</span>
</span><span id="__span-43-11"><a id="__codelineno-43-11" name="__codelineno-43-11" href="#__codelineno-43-11"></a><span class="go">frontend      curl           10.43.65.249  None     1/1</span>
</span><span id="__span-43-12"><a id="__codelineno-43-12" name="__codelineno-43-12" href="#__codelineno-43-12"></a><span class="go">frontend      productpage    10.43.70.80   None     1/1</span>
</span><span id="__span-43-13"><a id="__codelineno-43-13" name="__codelineno-43-13" href="#__codelineno-43-13"></a><span class="go">istio-ingress gateway-istio  10.43.246.228 None     1/1</span>
</span></code></pre></div>
</li>
<li>
<p>Verify that all workloads are assigned workload identities:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a>istioctl<span class="w"> </span>ztunnel-config<span class="w"> </span>certificate
</span></code></pre></div>
<div class="language-console highlight"><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="go">CERTIFICATE NAME                                               TYPE     STATUS        VALID CERT     SERIAL NUMBER                        NOT AFTER                NOT BEFORE</span>
</span><span id="__span-45-2"><a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a><span class="go">spiffe://cluster.local/ns/backend/sa/bookinfo-details          Leaf     Available     true           f0bc69c12ed191f83365b2297890f248     2025-06-06T04:54:09Z     2025-06-05T04:52:09Z</span>
</span><span id="__span-45-3"><a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a><span class="go">spiffe://cluster.local/ns/backend/sa/bookinfo-details          Root     Available     true           c4cc571dc92335d57cb6cf3ab78f99a8     2035-06-02T08:05:55Z     2025-06-04T08:05:55Z</span>
</span><span id="__span-45-4"><a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a><span class="go">spiffe://cluster.local/ns/backend/sa/bookinfo-ratings          Leaf     Available     true           9f4722ba68e73146fa5c498fcacb5270     2025-06-06T04:54:09Z     2025-06-05T04:52:09Z</span>
</span><span id="__span-45-5"><a id="__codelineno-45-5" name="__codelineno-45-5" href="#__codelineno-45-5"></a><span class="go">spiffe://cluster.local/ns/backend/sa/bookinfo-ratings          Root     Available     true           c4cc571dc92335d57cb6cf3ab78f99a8     2035-06-02T08:05:55Z     2025-06-04T08:05:55Z</span>
</span><span id="__span-45-6"><a id="__codelineno-45-6" name="__codelineno-45-6" href="#__codelineno-45-6"></a><span class="go">spiffe://cluster.local/ns/backend/sa/bookinfo-reviews          Leaf     Available     true           8ad4912f768ac3f986e8d0014947af5a     2025-06-06T04:54:09Z     2025-06-05T04:52:09Z</span>
</span><span id="__span-45-7"><a id="__codelineno-45-7" name="__codelineno-45-7" href="#__codelineno-45-7"></a><span class="go">spiffe://cluster.local/ns/backend/sa/bookinfo-reviews          Root     Available     true           c4cc571dc92335d57cb6cf3ab78f99a8     2035-06-02T08:05:55Z     2025-06-04T08:05:55Z</span>
</span><span id="__span-45-8"><a id="__codelineno-45-8" name="__codelineno-45-8" href="#__codelineno-45-8"></a><span class="go">spiffe://cluster.local/ns/frontend/sa/bookinfo-productpage     Leaf     Available     true           49cd2a29fb479144ee898135a71c4ab9     2025-06-06T04:54:16Z     2025-06-05T04:52:16Z</span>
</span><span id="__span-45-9"><a id="__codelineno-45-9" name="__codelineno-45-9" href="#__codelineno-45-9"></a><span class="go">spiffe://cluster.local/ns/frontend/sa/bookinfo-productpage     Root     Available     true           c4cc571dc92335d57cb6cf3ab78f99a8     2035-06-02T08:05:55Z     2025-06-04T08:05:55Z</span>
</span><span id="__span-45-10"><a id="__codelineno-45-10" name="__codelineno-45-10" href="#__codelineno-45-10"></a><span class="go">spiffe://cluster.local/ns/frontend/sa/curl                     Leaf     Available     true           ffe564539de3ecccdbe4d53ef6230f05     2025-06-06T04:54:16Z     2025-06-05T04:52:16Z</span>
</span><span id="__span-45-11"><a id="__codelineno-45-11" name="__codelineno-45-11" href="#__codelineno-45-11"></a><span class="go">spiffe://cluster.local/ns/frontend/sa/curl                     Root     Available     true           c4cc571dc92335d57cb6cf3ab78f99a8     2035-06-02T08:05:55Z     2025-06-04T08:05:55Z</span>
</span></code></pre></div>
</li>
</ol>
<h2 id="assistant-one-more-time">Assistant, one more time</h2>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-46-1"><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a>gloo<span class="w"> </span>ambient<span class="w"> </span>migrate
</span></code></pre></div>
<p>Here is the output:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-47-1"><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="go">• Starting phase policy-simplification...</span>
</span><span id="__span-47-2"><a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a><span class="go">⚠ Phase policy-simplification has recommendations!</span>
</span><span id="__span-47-3"><a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a><span class="go">  🔮 AuthorizationPolicy is migrated and can be deleted: kubectl delete authorizationpolicies.security.istio.io -n backend details-authz</span>
</span><span id="__span-47-4"><a id="__codelineno-47-4" name="__codelineno-47-4" href="#__codelineno-47-4"></a><span class="go">  🔮 AuthorizationPolicy is migrated and can be deleted: kubectl delete authorizationpolicies.security.istio.io -n backend ratings-authz</span>
</span></code></pre></div>
<p>The only task remaining, it appears, is to remove the now redundant, original authorization policies for <code>details</code> and <code>ratings</code> services.</p>
<p>Make it so:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-48-1"><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a>kubectl<span class="w"> </span>delete<span class="w"> </span>authorizationpolicies.security.istio.io<span class="w"> </span>-n<span class="w"> </span>backend<span class="w"> </span>details-authz
</span><span id="__span-48-2"><a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a>kubectl<span class="w"> </span>delete<span class="w"> </span>authorizationpolicies.security.istio.io<span class="w"> </span>-n<span class="w"> </span>backend<span class="w"> </span>ratings-authz
</span></code></pre></div>
<p>Finally, <code>gloo ambient migrate</code> should return "all-green" output.</p>
<p>But this does not, in my opinion, replace the need to verify for ourselves that everything functions as expected..</p>
<h2 id="test-everything">Test everything</h2>
<h3 id="test-ingress">Test Ingress</h3>
<p>Capture the external IP address of the Gateway:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-49-1"><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="nb">export</span><span class="w"> </span><span class="nv">GW_IP</span><span class="o">=</span><span class="k">$(</span>kubectl<span class="w"> </span>get<span class="w"> </span>gtw<span class="w"> </span>-n<span class="w"> </span>istio-ingress<span class="w"> </span>gateway<span class="w"> </span><span class="se">\</span>
</span><span id="__span-49-2"><a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a><span class="w">  </span>-ojsonpath<span class="o">=</span><span class="s1">&#39;{.status.addresses[0].value}&#39;</span><span class="k">)</span>
</span></code></pre></div>
<p>Make a curl request to the ingress gateway using the configured hostname <code>bookinfo.example.com</code>:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-50-1"><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a>curl<span class="w"> </span>-s<span class="w"> </span>bookinfo.example.com/productpage<span class="w"> </span>--resolve<span class="w"> </span>bookinfo.example.com:80:<span class="nv">$GW_IP</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>title
</span></code></pre></div>
<h3 id="test-authorization-policies">Test authorization policies</h3>
<ol>
<li>
<p>A request from an unauthorized workload to the <code>productpage</code> service should be denied:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-51-1"><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a>kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>deploy/curl<span class="w"> </span>-n<span class="w"> </span>frontend<span class="w"> </span>--<span class="w"> </span><span class="se">\</span>
</span><span id="__span-51-2"><a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a><span class="w">  </span>curl<span class="w"> </span>-s<span class="w"> </span>--head<span class="w"> </span>productpage:9080/productpage
</span></code></pre></div>
</li>
<li>
<p>A request from an unauthorized workload to the <code>ratings</code> service should be denied:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-52-1"><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a>kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>deploy/curl<span class="w"> </span>-n<span class="w"> </span>frontend<span class="w"> </span>--<span class="w"> </span><span class="se">\</span>
</span><span id="__span-52-2"><a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a><span class="w">  </span>curl<span class="w"> </span>-s<span class="w"> </span>ratings.backend:9080/ratings/123
</span></code></pre></div>
<p>It should produce a response saying <code>RBAC: access denied</code>.</p>
</li>
<li>
<p>A request from an unauthorized workload to the <code>details</code> service should be denied:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-53-1"><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a>kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>deploy/curl<span class="w"> </span>-n<span class="w"> </span>frontend<span class="w"> </span>--<span class="w"> </span><span class="se">\</span>
</span><span id="__span-53-2"><a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a><span class="w">  </span>curl<span class="w"> </span>-s<span class="w"> </span>details.backend:9080/details/123
</span></code></pre></div>
</li>
<li>
<p>A request through the ingress gateway to product page and upstream should succeed:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-54-1"><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a>curl<span class="w"> </span>-s<span class="w"> </span>--head<span class="w"> </span>bookinfo.example.com/productpage<span class="w"> </span><span class="se">\</span>
</span><span id="__span-54-2"><a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a><span class="w">  </span>--resolve<span class="w"> </span>bookinfo.example.com:80:<span class="nv">$GW_IP</span>
</span></code></pre></div>
</li>
</ol>
<h3 id="test-traffic-policy">Test traffic policy</h3>
<p>Verify that all requests are routed to <code>reviews-v3</code> by making repeated calls to <code>productpage</code>:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-55-1"><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a>curl<span class="w"> </span>-s<span class="w"> </span>bookinfo.example.com/productpage<span class="w"> </span>--resolve<span class="w"> </span>bookinfo.example.com:80:<span class="nv">$GW_IP</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-m<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="s2">&quot;reviews-&quot;</span>
</span></code></pre></div>
<h2 id="summary">Summary</h2>
<p>We are running in ambient mode, and our mesh policies continue to function.</p>
<p>From a resource consumption point of view, we are now running a single waypoint, compared to one per pod back when we were running in sidecar mode.</p>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../migration-plan/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Migration plan">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Migration plan
              </div>
            </div>
          </a>
        
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["navigation.top", "navigation.instant", "navigation.tracking", "navigation.footer", "navigation.expand", "content.code.annotate", "content.code.copy", "content.tabs.link"], "search": "../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.50899def.min.js"></script>
      
    
  </body>
</html>